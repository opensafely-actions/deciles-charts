# deciles-charts

deciles-charts generates a table and a line chart for each [measure table][1] in an input directory.
The table has date, percentile, and value columns.
The line chart has date on the horizontal axis (`x`) and value on the vertical axis (`y`).
Deciles are plotted as dashed lines;
the median is plotted as a solid line.
For example, the following deciles chart was generated from dummy data:

![A deciles chart generated from dummy data](img/deciles_chart_has_sbp_event_by_stp_code.png)

[Using deciles to communicate variation][2] has several advantages when compared to the alternatives.
Consequently, deciles charts are used on [OpenPrescribing.net][]
and in several OpenSAFELY publications, such as [Curtis _et al._ (2021)][3].

## Usage

In summary:

* Use [cohort-extractor][] to extract several weekly or monthly cohorts.
* Use cohort-extractor to generate one or more measure tables from these cohorts.
* Use deciles-charts to generate a deciles chart for each measure table.

Let's walk through an example _project.yaml_.

The following cohort-extractor action extracts several monthly cohorts:

```yaml
generate_cohort:
  run: >
    cohortextractor:latest generate_cohort
      --study-definition study_definition
      --index-date-range "2021-01-01 to 2021-06-30 by month"
  outputs:
    highly_sensitive:
      cohort: output/input_2021-*.csv
```

The following cohort-extractor action generates one or more measure tables from these cohorts:

```yaml
generate_measures:
  run: >
    cohortextractor:latest generate_measures
      --study-definition study_definition
  needs: [generate_cohort]
  outputs:
    moderately_sensitive:
      measure: output/measure_*.csv
```

Finally, the following deciles-charts reusable action generates a deciles table and a deciles chart for each measure table.
Remember to replace `[version]` with [a deciles-charts version][4]:

```yaml
generate_deciles_charts:
  run: >
    deciles-charts:[version]
      --input-files output/measure_*.csv
      --output-dir output
  needs: [generate_measures]
  outputs:
    moderately_sensitive:
      deciles_charts: output/deciles_*_*.*
```

For each measure table, there will now be a deciles table and deciles chart.
For example, given a measure table called `measure_has_sbp_event_by_stp_code.csv`,
there will now be
a deciles table called `deciles_table_has_sbp_event_by_stp_code.csv` and
a deciles chart called `deciles_chart_has_sbp_event_by_stp_code.png`.

## Configuration

Pass configuration via the `config` property.
For example:

```yaml
generate_deciles_charts:
  run: >
    deciles-charts:[version]
      --input-files output/measure_*.csv
      --output-dir output
  config:
    show_outer_percentiles: false
    tables:
      output: true
    charts:
      output: true
  needs: [generate_measures]
  outputs:
    moderately_sensitive:
      deciles_charts: output/deciles_*_*.*
```

| Configuration            | Description                                                                                         |
| ------------------------ | --------------------------------------------------------------------------------------------------- |
| `show_outer_percentiles` | Show the top and bottom percentiles, as well as the deciles                                         |
| `tables.output`          | Generate a deciles table for each measure table that is matched by the `--input-files` glob pattern |
| `charts.output`          | Generate a deciles chart for each measure table that is matched by the `--input-files` glob pattern |

## Terminology

**Measure table**<br>
Generated by cohort-extractor's `generate_measures` function;
contains data for one measure for *all* index dates in a range
(a *partial* measure table contains data for one measure for *one* index date in a range)

**Deciles table**<br>
Derived from a measures table

**Deciles chart**<br>
Derived from a deciles table

## Notes for developers

Please see [_DEVELOPERS.md_](DEVELOPERS.md).

## A note on versions

Because of a bug in the GitHub workflow that tagged versions,
some versions of deciles-charts are ordered incorrectly:
a later version precedes an earlier version,
when versions are sorted by the dates their associated commits were created.
For example, v0.0.44 (later) precedes v0.0.43 (earlier).
The bug was fixed in [#114][].

[1]: https://docs.opensafely.org/measures/
[2]: https://www.thedatalab.org/blog/2019/04/communicating-variation-in-prescribing-why-we-use-deciles/
[3]: https://www.opensafely.org/research/2021/service-restoration-observatory-1/
[4]: https://github.com/opensafely-actions/deciles-charts/tags
[#114]: https://github.com/opensafely-actions/deciles-charts/pull/114
[OpenPrescribing.net]: https://openprescribing.net/
[cohort-extractor]: https://docs.opensafely.org/actions-cohortextractor/
